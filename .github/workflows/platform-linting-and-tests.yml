name: Platform Linting and Tests

on:
  workflow_call:
    inputs:
      should-skip-running-and-always-succeed:
        description: "Whether to force the checks to succeed"
        required: false
        type: boolean

jobs:
  platform-linting-and-tests:
    name: Platform Linting and Tests
    runs-on: blacksmith-4vcpu-ubuntu-2404
    defaults:
      run:
        working-directory: ./platform
    steps:
      - name: Checkout project
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Setup environment
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        uses: ./.github/actions/setup-env
        continue-on-error: ${{ inputs.should-skip-running-and-always-succeed }}
        with:
          working-directory: ./platform

      - name: Setup environment variables
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        run: cp .env.example .env

      - name: Type checking, linting, formatting checks
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        run: pnpm check:ci

  platform-e2e-tests:
    name: Platform e2e Tests
    runs-on: blacksmith-4vcpu-ubuntu-2404
    steps:
      - name: Checkout repository
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Setup environment
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        uses: ./.github/actions/setup-env
        with:
          working-directory: ./platform

      - name: Install Kind
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        uses: helm/kind-action@92086f6be054225fa813e0a4b13787fc9088faab # v1.13.0
        with:
          config: .github/kind.yaml
          cluster_name: archestra-ci-cluster
          install_only: false

      - name: Debug Kind cluster
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        run: |
          echo "=== Kind version ==="
          kind version
          echo "=== Available clusters ==="
          kind get clusters || echo "No clusters found"
          echo "=== Docker containers ==="
          docker ps -a | grep kind || echo "No kind containers found"
          echo "=== Kubectl context ==="
          kubectl config current-context || echo "No kubectl context"
          echo "=== Kubectl cluster info ==="
          kubectl cluster-info || echo "Cluster info failed"

      - name: Setup Blacksmith Builder
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        uses: useblacksmith/setup-docker-builder@78f41686563c732ccc097f7baac2f092f67538f0 # v1

      - name: Build Docker image
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        uses: useblacksmith/build-push-action@30c71162f16ea2c27c3e21523255d209b8b538c1 # v2
        with:
          context: ./platform
          file: ./platform/Dockerfile
          push: false
          load: true
          tags: archestra/platform:ci-test

      - name: Load Docker image into kind
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        run: kind load docker-image archestra/platform:ci-test --name archestra-ci-cluster

      - name: Deploy WireMock to Kubernetes
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        run: |
          helm install wiremock ./platform/helm/wiremock --wait --timeout=2m

      - name: Deploy Archestra Platform with Helm
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        run: |
          helm install archestra-platform ./platform/helm/archestra \
            --values .github/values-ci.yaml \
            --set archestra.image=archestra/platform:ci-test \
            --wait --timeout=5m

      - name: Verify deployment
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        run: |
          echo "=== Kubernetes Pods ==="
          kubectl get pods -o wide

          echo "=== Kubernetes Services ==="
          kubectl get services

          echo "=== Archestra Platform Logs ==="
          kubectl logs -l app.kubernetes.io/name=archestra-platform --tail=50

      - name: Wait for services to be healthy
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        run: |
          echo "Waiting for platform pods to be ready..."
          kubectl wait --for=condition=Ready pods -l app.kubernetes.io/name=archestra-platform --timeout=120s
          echo "Platform pods are ready"

          echo "Verifying services are accessible..."
          curl --retry 10 --retry-delay 2 --retry-connrefused http://localhost:3000/ || (echo "Frontend not accessible" && exit 1)
          curl --retry 10 --retry-delay 2 --retry-connrefused http://localhost:9000/health || (echo "Backend not accessible" && exit 1)
          echo "All services are ready"

      - name: Get Playwright version
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        working-directory: ./platform/e2e-tests
        run: |
          echo "PLAYWRIGHT_VERSION=$(cat ./package.json | jq -r '.devDependencies["@playwright/test"]')" >> $GITHUB_ENV

      - name: Cache Playwright binaries and dependencies
        id: playwright-cache
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ env.PLAYWRIGHT_VERSION }}-chromium-webkit-firefox

      # see https://github.com/microsoft/playwright/issues/7249#issuecomment-2806545369
      - name: Install Playwright browsers
        if: inputs.should-skip-running-and-always-succeed != true && steps.playwright-cache.outputs.cache-hit != 'true'
        working-directory: ./platform/e2e-tests
        run: pnpm exec playwright install --with-deps chromium webkit firefox

      # See here https://github.com/microsoft/playwright/issues/30538#issuecomment-2185965508
      # basically some webkit dependencies lay outside of ~/.cache/ms-playwright, so we still need to
      # explicitly install, just the webkit ones, each time ðŸ¥²
      - name: Install Playwrightsystem dependencies for WebKit
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        working-directory: ./platform/e2e-tests
        run: pnpm exec playwright install-deps webkit

      - name: Run E2E tests
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        working-directory: ./platform
        run: pnpm test:e2e

      - name: Upload Playwright report
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: platform/e2e-tests/playwright-report/
          retention-days: 30

      - name: Show logs on failure
        if: failure()
        run: |
          echo "=== Kubernetes Pods ==="
          kubectl get pods -o wide

          echo "=== Kubernetes Services ==="
          kubectl get services

          echo "=== Archestra Platform Logs ==="
          kubectl logs -l app.kubernetes.io/name=archestra-platform --tail=200

          echo "=== PostgreSQL Logs ==="
          kubectl logs -l app.kubernetes.io/name=postgresql --tail=200

          echo "=== WireMock Logs ==="
          kubectl logs -l app=wiremock --tail=200

          echo "=== Describe Archestra Platform Pod ==="
          kubectl describe pod -l app.kubernetes.io/name=archestra-platform

          echo "=== Describe PostgreSQL Pod ==="
          kubectl describe pod -l app.kubernetes.io/name=postgresql

  helm-chart-linting-and-tests:
    name: Helm Chart Linting and Tests
    runs-on: blacksmith-4vcpu-ubuntu-2404
    defaults:
      run:
        working-directory: ./platform/helm/archestra
    steps:
      - name: Checkout project
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Linting
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        run: helm lint .

      - name: Tests
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        run: |
          helm plugin install https://github.com/helm-unittest/helm-unittest.git
          helm unittest .

      - name: helm package
        if: ${{ inputs.should-skip-running-and-always-succeed != true }}
        # NOTE: can't use ${{ github.sha }} for version here because it's not a valid version number
        # and helm package explicitly checks this
        run: |
          helm package . --version v0.0.1 --app-version v0.0.1
